{{define "content"}}

<div class="content-wrapper">

    <div class="banners">
    <div id="banner">
        <img src="/banner/{{.BoardID}}/{{.Banner}}" alt="Banner">
    </div>
    </div>
    <hr>
    <a href="#" onclick="loadForm(); return false;" class="createpost">Post a Reply</a>
    <hr>
     <div class="container">
        <span>{{.SelfPosts}} self</span>
        <fieldset id="thread" id="{{.Thread.PostID}}">
            <legend>{{.Thread.Author}} // <span class="subject">{{.Thread.Subject}}</span> - {{.Thread.BoardID}}/{{.Thread.ThreadID}} @
                {{.Thread.Timestamp}}{{if .Thread.ImageURL}} <span>File: <span class="file">{{.Thread.ImageURL}}</span></span>{{end}}{{if .IsAdmin}}<a class="mod" href="#" onclick="deleteThread()">Delete Thread</a>|<a class="mod"
                href="https://whatismyipaddress.com/ip/{{.Thread.IP}}" target="_blank">{{.Thread.IP}}</a>{{else if .IsJanny}}<a class="mod" href="#" onclick="deleteThread()">Delete Thread</a>|<a class="mod"
                href="https://whatismyipaddress.com/ip/{{.Thread.IP}}" target="_blank">{{.Thread.IP}}</a>{{end}} <a class="postid" href="#" data-id="{{.Thread.PostID}}">#{{.Thread.PostID}}</a></legend>
            {{if .Thread.ImageURL}}
            <img src="/file/{{.BoardID}}/{{.Thread.ImageURL}}" alt="Image" id="threadfile">
            {{end}}
            <p class="postcontent">{{.Thread.Content}}</p>
            <span>{{.Thread.Upvotes}} / {{.Thread.Downvotes}} <a href="#" onclick="threadupvote('{{.Thread.ThreadID}}')">Upvote</a> | <a href="#" onclick="threaddownvote('{{.Thread.ThreadID}}')">Downvote</a></span>
            <script>
                const threadfile = document.getElementById("threadfile");
                const srcurl = threadfile.src;
                if (/\.(png|jpg|jpeg|gif)$/i.test(srcurl)) {
                } else if (/\.(webm|mp4)$/i.test(srcurl)) {
                    threadfile.outerHTML = `<video controls><source src="${srcurl}" type="video/${srcurl.split('.').pop()}"></video>`;
                } else if (/\.(mp3|wav)$/i.test(srcurl)) {
                    threadfile.outerHTML = `<audio controls><source src="${srcurl}" type="audio/${srcurl.split('.').pop()}"></audio>`;
                } else {
                    threadfile.outerHTML = `<a href="${srcurl}">Download File</a>`;
                }
            </script>
        </fieldset>
        {{if .IsAdmin}}
        <script>
            const url = "/admin/delete/{{.Thread.BoardID}}/{{.Thread.ThreadID}}";
            const threadid = {{.Thread.ThreadID }};
            const boardid = {{.Thread.BoardID }};
            const deleteThread = async () => {
                const response = await fetch(url, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ threadid, boardid })
                });
                if (response.ok) {
                    window.location.href = "/board/{{.Thread.BoardID}}";
                }
            }
        </script>
        {{else if .IsJanny }}
        <script>
            const url = "/janny/delete/{{.Thread.BoardID}}/{{.Thread.ThreadID}}";
            const threadid = {{.Thread.ThreadID }};
            const boardid = {{.Thread.BoardID }};
            const deleteThread = async () => {
                const response = await fetch(url, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ threadid, boardid })
                });
                if (response.ok) {
                    window.location.href = "/board/{{.Thread.BoardID}}";
                }
            }
        </script>
        {{end}}
        <div id="posts">
            <script>
                const boardID = "{{.BoardID}}";
                const threadID = "{{.ThreadID}}";
                const deletePost = async (postid) => {
                    const url = `{{if .IsAdmin}}/admin/delete/{{else}}/janny/delete/{{end}}${boardID}/${threadID}/` + postid;
                    const response = await fetch(url, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if (response.ok) {
                        window.location.reload();
                    }
                }
            </script>
            {{range .Posts}}
            <fieldset class="post">
                <legend><span class="postid" data-id="{{.PostID}}">{{.PostID}}</span> <span>{{.Author}}</span> <span>{{.Timestamp}}</span>{{if .ImageURL}} <span>File: {{.ImageURL}}</span>{{end}}
                    {{if $.IsAdmin}}<a class="mod" href="#" onclick="deletePost('{{.PostID}}')">Delete Post</a> |{{end}}
                    <a class="mod" href="https://whatismyipaddress.com/ip/{{.IP}}" target="_blank">{{.IP}}</a>
                </legend>
                {{if .ImageURL}}
                <img src="/file/{{.BoardID}}/{{.ImageURL}}" alt="Post Image" class="postfile">
                {{end}}
                <p class="postcontent">{{.Content}}</p>
                <span>{{.Upvotes}} / {{.Downvotes}} <a href="#" onclick="upvote('{{.PostID}}')">Upvote</a> | <a href="#" onclick="downvote('{{.PostID}}')">Downvote</a></span>
            </fieldset>
            {{end}}
        </div>
    </div>
    <script>
        const upvote = async (postid) => {
            const url = `/vote/up/${boardID}/${threadID}/${postid}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
    
            if (response.ok) {
                window.location.reload(); // Reload on success
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || "Failed to upvote"}`);
            }
        }
    
        const downvote = async (postid) => {
            const url = `/vote/down/${boardID}/${threadID}/${postid}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
    
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || "Failed to downvote"}`);
            }
        }
    
        const threadupvote = async (threadid) => {
            const url = `/vote/up/${boardID}/${threadid}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
    
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || "Failed to upvote thread"}`);
            }
        }
    
        const threaddownvote = async (threadid) => {
            const url = `/vote/down/${boardID}/${threadid}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
    
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || "Failed to downvote thread"}`);
            }
        }
    </script>
    
            <script>
                document.querySelectorAll(".postfile").forEach(postfile => {
                    const postsrc = postfile.src;
                    if (/\.(png|jpg|jpeg|gif)$/i.test(postsrc)) {
                        // Image handling logic here, if necessary
                    } else if (/\.(webm|mp4)$/i.test(postsrc)) {
                        postfile.outerHTML = `<video controls><source src="${postsrc}" type="video/${postsrc.split('.').pop()}"></video>`;
                    } else if (/\.(mp3|wav)$/i.test(postsrc)) {
                        postfile.outerHTML = `<audio controls><source src="${postsrc}" type="audio/${postsrc.split('.').pop()}"></audio>`;
                    } else {
                        postfile.outerHTML = `<a href="${postsrc}">Download File</a>`;
                    }
                });
            </script>
        </div>
        <hr>
        <a href="#" onclick="loadForm(); return false;" class="createpost">Post a Reply</a>
        <hr>
        <fieldset class="reply">
            <legend>Reply</legend>
            <form action="/board/{{.Thread.BoardID}}/{{.Thread.ThreadID}}" method="post" enctype="multipart/form-data" id="postform">
                <input type="text" id="boardID" name="b" value="{{.BoardID}}" hidden><br><br>
                <label for="author">Username:</label>
                <input type="text" id="author" name="author" value="Anonymous" required><br><br>
                <label for="content">Post:</label>
                <textarea id="formcontent" name="content" maxlength="500"></textarea><br><br>
                <div id="charCount">500 characters remaining</div>
                <label for="image">Image:</label>
                <input type="file" id="image" name="image" accept="image/*"><br><br>
                <a href="#" id="submitpost" return false;>Submit</a>
            </form>
        </fieldset>
        <script>
            //show current chars/maxlength at the bottom right of the textarea
            document.addEventListener('DOMContentLoaded', function() {
                const formcontent = document.getElementById('formcontent');
                if (formcontent) {
                    const maxLength = formcontent.getAttribute('maxlength');
                    formcontent.addEventListener('input', function() {
                        const currentLength = formcontent.value.length;
                        const remainingChars = maxLength - currentLength;
                        document.getElementById('charCount').innerText = `${remainingChars} characters remaining`;
                    });
                } else {
                    console.error('Element with ID "formcontent" not found.');
                }
            });

        </script>
        <script>
            //axios for form submission
            document.getElementById('submitpost').addEventListener('click', function() {
                const postform = document.getElementById('postform'); // Select the form with the specific ID
                const postformData = new FormData(postform);
                axios.post(postform.action, postformData)
                    .then(response => {
                        location.reload(); // Reload the page to see the new thread
                    })
                    .catch(error => {
                        console.error(error);
                    });
            });
        </script>
    </div>
    <script>

          document.addEventListener("DOMContentLoaded", function() {
            const postContents = document.getElementsByClassName('postcontent');
            for (let i = 0; i < postContents.length; i++) {
              postContents[i].innerHTML = marked.parse(postContents[i].innerHTML);
            }
          });
 </script>
</div>
<div id="cirno">
    <img src="/assets/cirno.png" alt="Cirno">
</div>
<style>
    .content-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
        width: 100%;
        margin-top: 1.5rem;
    }

    .banners {
margin: 0 auto;
width: 100%;
margin-top: 2rem;
margin-bottom: 2rem;
    }


    #thread {
        display: flex;
        flex-direction: row;
        justify-content: left;
        align-items: center;
        word-break: break-all;
        border-top: 5px solid #494949;
        border-left: 1px solid #494949;
        border-right: 1px solid #494949;
        border-bottom: 1px solid #494949;

        background-color: #1b1b1b7a;

    }
    #thread img {
        max-width: 400px;
        max-height: 400px;
    }
    .post {
        display: flex;
        flex-direction: row;
        justify-content: left;
        align-items: center;
        word-break: break-all;
        border-top: 5px solid #494949;
        border-left: 1px solid #494949;
        border-right: 1px solid #494949;
        border-bottom: 1px solid #494949;

        background-color: #1b1b1b7a;
        width: 100%;
        min-height: 100px;
    }
    .post a:hover {
        color: #FFF;
    }
    .post img {
        max-width: 250px;
        max-height: 250px;
    }
    .post video {
        max-width: 250px;
        max-height: 250px;
    }
    .post p {
        margin: 10px;
    }
    
    .createpost {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;

        width: 200px;
        text-align: center;
        padding: 10px;
        background-color: #494949;
        border: 1px solid #1a1a1a;
        text-decoration: none;
    }
    .createpost:hover {
        background-color: #1a1a1a;
    }
    
    #cirno {
        position: fixed;
        bottom: 0;
        right: 0;
    }
    #cirno img {
        max-width: 100px;
        max-height: 100px;
    }
    .mod {
        color: rgb(255, 0, 0);
        text-decoration: none;
    }
    hr {
        border: 1px solid #494949;
        width: 100%;
    }

    .replyquote {
        color: rgb(6, 255, 243);
    }
    .replyquote a {
        color: rgb(6, 255, 243);
        text-decoration: none;
    }

    .postcontent {
        padding: 10px;
    }

    .file {
        color: #055685;
    }

    .subject {
        color: #73ff00;
    }

</style>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.reply');
        const postContents = document.querySelectorAll('.postcontent');

        // Function to toggle the visibility of the reply form
        const loadForm = () => {
            form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
        };

        // Function to display the reply form
        const openForm = () => {
            form.style.display = 'flex';
        };

        // Decode HTML entities
        const decodeHtmlEntities = (html) => {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = html;
            return textarea.value;
        };
// Function to scroll to the post with the given ID
// Function to scroll to the post with the given ID
const showPost = (postId) => {
        const post = document.querySelector(`.postid[data-id='${postId}']`);
        if (post) {
            post.scrollIntoView({ behavior: 'smooth' });
        }
    };

    // Attach showPost to the window object to make it globally accessible
    window.showPost = showPost;

    // Apply greentext formatting
    const greenText = () => {
        const gtext = document.querySelectorAll('.postcontent p');
        gtext.forEach(post => {
            let lines = post.innerHTML.split('\n');
            lines = lines.map(line => {
                if (line.startsWith('&gt;&gt;')) {
                    // capture the post ID and format it
                    const postId = line.slice(4).trim();
                    return `<span class="replyquote"><a href="#" onclick="showPost('${postId}');">${postId}</a></span>`;
                } else if (line.startsWith('&gt;')) {
                    return `<span style="color: green;">${line}</span>`;
                } else {
                    return line;
                }
            });
            post.innerHTML = lines.join('\n');
        });
    };
        // Apply markdown parsing
        const applyMarkdown = () => {
            postContents.forEach(post => {
                post.innerHTML = marked.parse(decodeHtmlEntities(post.innerHTML));
            });
        };

        // Decode and update posts
        const updatePosts = () => {
            postContents.forEach(post => {
                post.innerHTML = decodeHtmlEntities(post.innerHTML);
            });
        };

        // Add a reply reference to a specific post
        const replyTo = (postid) => {
            openForm();
            const content = document.getElementById('formcontent');
            content.value += `\n>>${postid}\n`;
            content.focus();
        };

        // Draggable reply form
        let isDragging = false;
        let offset = [0, 0];

        const startDragging = (e) => {
            if (e.target.tagName.toLowerCase() !== 'input' && e.target.tagName.toLowerCase() !== 'textarea') {
                isDragging = true;
                offset = [form.offsetLeft - e.clientX, form.offsetTop - e.clientY];
            }
        };

        const stopDragging = () => {
            isDragging = false;
        };

        const drag = (e) => {
            if (isDragging) {
                form.style.left = `${e.clientX + offset[0]}px`;
                form.style.top = `${e.clientY + offset[1]}px`;
            }
        };

        // Event listeners for dragging
        form.addEventListener('mousedown', startDragging, true);
        document.addEventListener('mouseup', stopDragging, true);
        document.addEventListener('mousemove', drag, true);

        // Initialize functionalities
        updatePosts();
        greenText();
        applyMarkdown();
    });

    const loadForm = () => {
        const form = document.querySelector('.reply');
        form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
    };

    const replyTo = (postid) => {
        const content = document.getElementById('formcontent');
        content.value += `\n>>${postid}\n`;
        content.focus();
    };
    
    const getSessionCookie = () => {
        const name = "session=";
        //get session cookie and log it to console
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        for(let i = 0; i < cookieArray.length; i++) {
            const cookie = cookieArray[i].trim();
            if (cookie.indexOf(name + "=") === 0) {
                console.log(cookie);
            }
        }
    }


    getSessionCookie();
</script>


{{end}}